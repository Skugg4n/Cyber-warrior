<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Warrior</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-black">
    <div id="root"></div>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel" src="data.js"></script>
    <script type="text/babel" src="FirewallMinigame.js"></script>
    <script type="text/babel">
    
// --- MOCK DATA ---
// NEW: Replaced placeholder missions with your specific PUSH/PULL/LEGS routines.
const getInitialState = () => {
  const savedData = localStorage.getItem('aegis_operator_data');
  if (savedData) {
    const data = JSON.parse(savedData);
    if (!data.xpMultiplier) data.xpMultiplier = 1;
    return data;
  }
  return {
    id: `#${Math.random().toString(16).substr(2, 6).toUpperCase()}`,
    level: 1,
    xp: 0,
    xpToNextLevel: 1000,
    xpMultiplier: 1,
    systemIntegrity: '100.0%',
    cCreds: 0,
    augments: ['Stock Chassis Mk I'],
    inventory: [],
  };
};


// --- HELPER COMPONENTS ---

const Typewriter = ({ text, speed = 30 }) => {
  const [displayedText, setDisplayedText] = React.useState('');
  React.useEffect(() => {
    let i = 0;
    setDisplayedText('');
    const intervalId = setInterval(() => {
      if (i < text.length) {
        setDisplayedText(prev => prev + text.charAt(i));
        i++;
      } else {
        clearInterval(intervalId);
      }
    }, speed);
    return () => clearInterval(intervalId);
  }, [text, speed]);
  return <span>{displayedText}<span className="animate-pulse">_</span></span>;
};

// --- MAIN UI COMPONENTS ---

const BBSHeader = ({ operator, onNav }) => (
  <div className="border-2 border-green-500 p-2 font-mono text-green-400 bg-black">
    <div className="flex justify-between items-center border-b-2 border-green-500 pb-1 mb-1">
      <h1 className="text-lg md:text-xl font-bold">[A.E.G.I.S] PROTOCOL v1.1</h1>
      <div className="text-xs text-right">
        <div>OPERATOR ID: {operator.id}</div>
        <div>SYS. INTEGRITY: {operator.systemIntegrity}</div>
        <div>C-Creds: {operator.cCreds}c</div>
      </div>
    </div>
    <div className="flex justify-around text-xs md:text-sm">
        <button onClick={() => onNav('board')} className="hover:bg-green-500 hover:text-black p-1">[1] //MSG_BOARD</button>
        <button onClick={() => onNav('profile')} className="hover:bg-green-500 hover:text-black p-1">[2] OPERATOR_PROFILE</button>
        <button onClick={() => onNav('market')} className="hover:bg-green-500 hover:text-black p-1">[3] //BLACK_MARKET</button>
        <button className="text-gray-600 p-1 cursor-not-allowed">[4] LOGOUT</button>
    </div>
  </div>
);

const MissionBoard = ({ missions, onSelectMission }) => (
  <div className="p-2 md:p-4">
    <h2 className="text-lg font-bold mb-2 text-green-400">{'>'} INCOMING DIRECTIVES...</h2>
    <div className="space-y-4">
      {missions.map(mission => (
        <div key={mission.id} className="border border-green-500 p-2 bg-black/50">
          <p className="text-green-400 font-bold">{mission.title}</p>
          <p className="text-xs text-gray-400 mb-2">FROM: {mission.from}</p>
          <p className="text-sm mb-2 text-gray-300">{mission.description}</p>
          <div className="flex justify-between items-center">
             <p className="text-xs text-green-400">REWARD: {mission.reward}</p>
             <button onClick={() => onSelectMission(mission.id)} className="bg-green-600 text-black font-bold py-1 px-3 hover:bg-green-400 border border-green-400">
                ACCEPT
             </button>
          </div>
        </div>
      ))}
    </div>
  </div>
);

const OperatorProfile = ({ operator, onNav }) => (
    <div className="p-2 md:p-4">
        <h2 className="text-lg font-bold mb-2 text-green-400">{'>'} OPERATOR_PROFILE [ {operator.id} ]</h2>
        <div className="border border-green-500 p-2 bg-black/50 space-y-2">
            <div>
                <p className="text-green-400">LEVEL:</p>
                <p className="text-white text-xl ml-4">{operator.level}</p>
            </div>
            <div>
                <p className="text-green-400">DATA PACKETS (XP):</p>
                <div className="w-full bg-gray-800 border border-green-500 my-1">
                    <div className="bg-green-500 text-xs font-medium text-black text-center p-0.5 leading-none" style={{width: `${(operator.xp / operator.xpToNextLevel) * 100}%`}}>
                        {operator.xp} / {operator.xpToNextLevel}
                    </div>
                </div>
            </div>
            <div>
                <p className="text-green-400">C-CREDS:</p>
                <p className="ml-4 text-white">{operator.cCreds}c</p>
            </div>
            <div>
                <p className="text-green-400">AUGMENTATIONS:</p>
                <ul className="list-disc list-inside ml-4 text-green-400">
                    {operator.augments.map((aug, index) => (
                        <li key={index}>{aug}</li>
                    ))}
                </ul>
            </div>
             <p className="text-xs text-gray-500 mt-4">// More detailed stats and schematics coming in v1.1</p>
        </div>
         <button onClick={() => onNav('board')} className="mt-4 bg-green-600 text-black font-bold py-1 px-3 hover:bg-green-400 border border-green-400">
            &lt; RETURN TO BOARD
         </button>
    </div>
);


const BlackMarket = ({ operator, onPurchase, onNav }) => (
    <div className="p-2 md:p-4">
        <h2 className="text-lg font-bold mb-2 text-green-400">{'//'}BLACK_MARKET - Encrypted Node</h2>
        <p className="text-sm mb-2">OPERATOR C-Creds: {operator.cCreds}c</p>
        <div className="border border-green-500 p-2 bg-black/50 space-y-2">
            {marketItems.map(item => (
                <div key={item.id} className="border-b border-gray-700 pb-2">
                    <p>{'>'} {item.name} [COST: {item.cost}c]</p>
                    <p className="text-xs text-gray-400">{item.description}</p>
                    <button onClick={() => onPurchase(item)} className="mt-1 bg-green-600 text-black font-bold py-1 px-2 hover:bg-green-400 border border-green-400">[PURCHASE]</button>
                </div>
            ))}
        </div>
        <button onClick={() => onNav('board')} className="mt-4 bg-green-600 text-black font-bold py-1 px-3 hover:bg-green-400 border border-green-400">&lt; RETURN TO BOARD</button>
    </div>
);


// --- WORKOUT LOGGER COMPONENTS ---

const SetLogger = ({ exercise, loggedSets, onLogSet }) => {
    const [reps, setReps] = React.useState('');
    const [weight, setWeight] = React.useState('');

    const handleLogSet = (e) => {
        e.preventDefault();
        onLogSet(exercise.id, reps, weight);
        // Clear inputs for next set
        setReps('');
        setWeight('');
    };
    
    return (
        <div className="bg-black/70 p-2 mt-1">
            <div className="grid grid-cols-4 gap-2 text-center text-xs text-green-400 mb-1">
                <div>SET</div>
                <div>PREVIOUS</div>
                <div>WEIGHT</div>
                <div>REPS</div>
            </div>
            {loggedSets.map((set, index) => (
                 <div key={index} className="grid grid-cols-4 gap-2 text-center items-center text-sm mb-1">
                    <div className="text-green-400">[SET {index + 1}]</div>
                    <div className="text-gray-500">-</div>
                    <div className="text-white">{set.weight || '-'} kg</div>
                    <div className="text-white">{set.reps}</div>
                </div>
            ))}
            <form onSubmit={handleLogSet} className="grid grid-cols-4 gap-2 text-center items-center">
                <div className="text-green-400">[SET {loggedSets.length + 1}]</div>
                <div className="text-xs text-gray-400">{exercise.previous}</div>
                <input 
                    type="number" 
                    placeholder="KG" 
                    value={weight}
                    onChange={(e) => setWeight(e.target.value)}
                    className="bg-gray-900 border border-green-500 text-white p-1 w-full text-center font-mono focus:outline-none focus:ring-1 focus:ring-green-500"
                />
                <input 
                    type="number" 
                    placeholder="REPS" 
                    value={reps}
                    onChange={(e) => setReps(e.target.value)}
                    className="bg-gray-900 border border-green-500 text-white p-1 w-full text-center font-mono focus:outline-none focus:ring-1 focus:ring-green-500"
                />
                <button type="submit" className="col-span-4 mt-2 bg-green-600 text-black font-bold py-1 px-2 hover:bg-green-400 border border-green-400">
                    LOG SET {loggedSets.length + 1}
                </button>
            </form>
        </div>
    );
};

const WorkoutLogger = ({ mission, onCompleteMission, onUpdateXp, onUpdateCCreds }) => {
    const [expandedExerciseId, setExpandedExerciseId] = React.useState(mission.exercises[0].id);
    const [sessionSets, setSessionSets] = React.useState({});
    const [feedback, setFeedback] = React.useState('// Begin directive.');
    const [isResting, setIsResting] = React.useState(false);
    const [showDefrag, setShowDefrag] = React.useState(false);

    const [restTimeLeft, setRestTimeLeft] = React.useState(0);
    const handleToggleExercise = (exerciseId) => {
        setExpandedExerciseId(currentId => (currentId === exerciseId ? null : exerciseId));
    };
    React.useEffect(() => {
        if (isResting && restTimeLeft > 0) {
            const timerId = setTimeout(() => setRestTimeLeft(restTimeLeft - 1), 1000);
            return () => clearTimeout(timerId);
        } else if (isResting && restTimeLeft === 0) {
            setIsResting(false);
            setShowDefrag(false);
            setFeedback("// REST PERIOD COMPLETE. RESUME DIRECTIVE.");
        }
    }, [isResting, restTimeLeft]);

    const handleLogSet = (exerciseId, reps, weight) => {
        if (!reps) {
            setFeedback('// ERROR: Reps value required.');
            setTimeout(() => setFeedback(''), 2000);
            return;
        }
        const newSet = { reps: parseInt(reps), weight: weight ? parseInt(weight) : 0 };
        const currentSets = sessionSets[exerciseId] || [];
        setSessionSets({ ...sessionSets, [exerciseId]: [...currentSets, newSet] });
        const xpGained = Math.floor(newSet.reps * (newSet.weight || 1) * 0.5);
        onUpdateXp(xpGained);

        const exercise = mission.exercises.find(e => e.id === exerciseId);
        const prevMatch = exercise.previous.match(/(\d+\.?\d*)kg x (\d+)/);
        let breakthrough = false;
        if (prevMatch) {
            const prevW = parseFloat(prevMatch[1]);
            const prevR = parseInt(prevMatch[2]);
            if (newSet.weight > prevW || newSet.reps > prevR) {
                breakthrough = true;
            }
        }
        if (breakthrough) {
            onUpdateCCreds(5);
            setFeedback(`// BREAKTHROUGH! +${xpGained} XP, +5 C-Creds`);
        } else {
            setFeedback(`// LOGGED: ${reps}x${weight || 0}kg. +${xpGained} DATA PACKETS`);
        }
        setIsResting(true);
        setRestTimeLeft(90);
        setShowDefrag(false);
        setFeedback("// SET LOGGED. REST PERIOD INITIATED...");
    };

    const allExercisesComplete = mission.exercises.every(ex => (sessionSets[ex.id] || []).length >= ex.targetSets);

    return (
        <div className="p-2 md:p-4">
            <h2 className="text-lg font-bold mb-1 text-red-500 animate-pulse">{'>'}! ACTIVE DIRECTIVE: {mission.title}</h2>
            {feedback && <p className="text-green-400 text-sm h-4 mb-2">{feedback}</p>}
            {isResting && (
                <div className="border-t-2 border-red-500 mt-4 pt-2">
                    <h3 className="text-red-500 font-bold">
                        // SYSTEM IDLE :: RESTING :: {restTimeLeft}s
                    </h3>
                    {!showDefrag ? (
                        <button
                            onClick={() => setShowDefrag(true)}
                            className="w-full bg-green-800 text-white font-bold py-2 px-3 mt-2 hover:bg-green-600 border border-green-600"
                        >
                            INITIATE //DEFRAG? [Y/N]
                        </button>
                    ) : (
                        <FirewallMinigame
                            timeLeft={restTimeLeft}
                            onGameEnd={(finalScore) => {
                                const cCredsAwarded = Math.floor(finalScore / 10);
                                if (cCredsAwarded > 0) {
                                    onUpdateCCreds(cCredsAwarded);
                                    setFeedback(`// DEFRAG COMPLETE. +${cCredsAwarded} C-Creds`);
                                }
                            }}
                        />
                    )}
                </div>
            )}
            <div className="border border-red-500 p-2 bg-black/50 space-y-2">
                {mission.exercises.map(exercise => {
                    const loggedSets = sessionSets[exercise.id] || [];
                    const isComplete = loggedSets.length >= exercise.targetSets;
                    const isExpanded = expandedExerciseId === exercise.id;
                    return (
                        <div key={exercise.id} className="border-b border-gray-700 pb-2">
                            <div className="flex justify-between items-center cursor-pointer" onClick={() => handleToggleExercise(exercise.id)}>
                                <div>
                                    <p className={`text-lg ${isExpanded ? 'text-green-400' : 'text-white'}`}>{exercise.name}</p>
                                    <p className="text-xs text-gray-400">TARGET: {exercise.targetSets} sets of {exercise.targetReps} reps</p>
                                </div>
                                <div className="text-right">
                                    <p className={`font-bold ${isComplete ? 'text-green-400' : 'text-gray-500'}`}>
                                        {loggedSets.length}/{exercise.targetSets} SETS {isComplete ? '[OK]' : ''}
                                    </p>
                                    <p className="text-green-400 text-xl">{isExpanded ? '[-]' : '[+]'}</p>
                                </div>
                            </div>
                            {isExpanded && <SetLogger exercise={exercise} loggedSets={loggedSets} onLogSet={handleLogSet} />}
                        </div>
                    );
                })}
            </div>
            <div className="mt-4">
                <button
                    onClick={() => onCompleteMission(mission.xp, allExercisesComplete)}
                    disabled={!allExercisesComplete}
                    className={`w-full font-bold py-2 px-3 border ${allExercisesComplete ? 'bg-red-600 text-white border-red-400 hover:bg-red-400 animate-pulse' : 'bg-gray-700 text-gray-500 border-gray-600 cursor-not-allowed'}`}
                >
                    {allExercisesComplete ? 'COMPLETE DIRECTIVE' : 'LOG ALL SETS TO COMPLETE'}
                </button>
            </div>
        </div>
    );
};

// --- MAIN APP COMPONENT ---

function App() {
  const [operator, setOperator] = React.useState(getInitialState());
  const [missions, setMissions] = React.useState(missionsData);
  const [currentScreen, setCurrentScreen] = React.useState('board');
  const [activeMission, setActiveMission] = React.useState(null);
  const [isLoading, setIsLoading] = React.useState(true);

  React.useEffect(() => { setTimeout(() => setIsLoading(false), 1500); }, []);

  React.useEffect(() => {
    localStorage.setItem("aegis_operator_data", JSON.stringify(operator));
  }, [operator]);
  const handleNavigation = (screen) => { setCurrentScreen(screen); };
  
  const handleSelectMission = (missionId) => {
    const mission = missions.find(m => m.id === missionId);
    setActiveMission(mission);
    setCurrentScreen('logging');
  };
  const handlePurchaseItem = React.useCallback((item) => {
    if (operator.cCreds < item.cost) return;
    if (item.id === "item_oc") {
        setOperator(prev => ({ ...prev, cCreds: prev.cCreds - item.cost, xpMultiplier: 1.5 }));
        alert("// Overclock.exe armed. Next directive will yield 1.5x XP.");
    } else if (item.id === "item_gf") {
        setOperator(prev => ({ ...prev, cCreds: prev.cCreds - item.cost, inventory: [...prev.inventory, item.id] }));
        alert("// Glitch_Filter.pak acquired and stored in inventory.");
    } else {
        setOperator(prev => ({ ...prev, cCreds: prev.cCreds - item.cost, inventory: [...prev.inventory, item.name] }));
    }
  }, [operator]);



  const handleUpdateXp = React.useCallback((xpGained) => {
    setOperator(prev => {
        const finalXp = Math.floor(xpGained * prev.xpMultiplier);
        const newXp = prev.xp + finalXp;
        if (newXp >= prev.xpToNextLevel) {
            return {
                ...prev,
                level: prev.level + 1,
                xp: newXp - prev.xpToNextLevel,
                xpToNextLevel: Math.floor(prev.xpToNextLevel * 1.5),
                augments: [...prev.augments, `System Upgrade v${prev.level + 1}`]
            };
        }
        return { ...prev, xp: newXp };
    });
  }, [operator.xpMultiplier]);

  const handleUpdateCCreds = React.useCallback((c) => {
    setOperator(prev => ({ ...prev, cCreds: prev.cCreds + c }));
  }, []);

  const handleCompleteMission = React.useCallback((baseXp, flawless) => {
    handleUpdateXp(baseXp);
    if (activeMission && activeMission.reward.includes("SCHEMATIC")) {
        const schematic = activeMission.reward.split("SCHEMATIC: ")[1];
        setOperator(prev => ({ ...prev, augments: [...prev.augments, schematic] }));
    }
    if (flawless) {
        const bonus = activeMission && activeMission.cCredBonus ? activeMission.cCredBonus : 50;
        handleUpdateCCreds(bonus);
    }
    if (operator.xpMultiplier !== 1) {
        setOperator(prev => ({ ...prev, xpMultiplier: 1 }));
    }
    setActiveMission(null);
    setCurrentScreen("board");
  }, [activeMission, handleUpdateXp, handleUpdateCCreds, operator.xpMultiplier]);

      case 'profile': return <OperatorProfile operator={operator} onNav={handleNavigation} />;
      case 'logging': return <WorkoutLogger mission={activeMission} onCompleteMission={handleCompleteMission} onUpdateXp={handleUpdateXp} onUpdateCCreds={handleUpdateCCreds} />;
      case 'market': return <BlackMarket operator={operator} onPurchase={handlePurchaseItem} onNav={handleNavigation} />;
      default: return <MissionBoard missions={missions} onSelectMission={handleSelectMission} />;
    }
  };
  
  if (isLoading) {
      return (
          <div className="bg-black text-green-400 h-screen flex flex-col items-center justify-center font-mono text-lg">
              <p><Typewriter text="CONNECTING TO [A.E.G.I.S] NODE 7..." /></p>
              <p><Typewriter text="ENCRYPTION HANDSHAKE... OK" /></p>
              <p><Typewriter text="BIOMETRIC SYNC... OK" /></p>
          </div>
      )
  }

  return (
    <div className="bg-black text-green-400 min-h-screen font-mono p-2 sm:p-4">
        <div className="max-w-4xl mx-auto bg-black/50 border-4 border-green-500">
            <BBSHeader operator={operator} onNav={handleNavigation} />
            <main className="p-2">
                {renderScreen()}
            </main>
            <footer className="border-t-2 border-green-500 p-1 text-center text-xs text-green-500">
                <p>AEGIS PROTOCOL v1.3 - "Firewall" | System Status: <span className="text-green-400">NOMINAL</span></p>
            </footer>
        </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
